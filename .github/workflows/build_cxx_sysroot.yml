name: Build C/C++ Sysroot

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

permissions:
  contents: read
  checks: write

jobs:
  build_cxx_sysroot:
    runs-on: ubuntu-latest
    container:
      image: archlinux:base-devel
      options: --user root --workdir /
    steps:
      - name: Update and install dependencies
        run: |
          pacman -Syu --noconfirm
          pacman -Sy --noconfirm coreutils nodejs npm wget git cmake ninja llvm clang rsync make lld wasmer cargo

      - name: Checkout
        uses: actions/checkout@v3
        with:
          submodules: true

      - name: Build
        run: |
          git config --global --add safe.directory $(pwd)
          ./build32.sh
          rm -rf /opt/wasix-sysroot
          cp -r sysroot /opt/wasix-sysroot
          cp .github/workflows/files/clang-wasix.cmake_toolchain /opt/wasix-sysroot/clang-wasix.cmake_toolchain

      - name: Upload sysroot
        if: ${{ !env.ACT }}
        uses: actions/upload-artifact@v2
        with:
          name: wasix-sysroot
          path: /opt/wasix-sysroot

      - name: Run WASIX tests
        run: |
          TOOLCHAIN=/opt/wasix-sysroot/clang-wasix.cmake_toolchain ./test/wasix/run_tests.sh
